<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Assistant Financier - Simulateur Gratuit</title>
    <meta name="description" content="L'outil ultime pour vos finances : Calculez vos int√©r√™ts compos√©s, votre capacit√© d'emprunt et comparez l'achat vs la location. Gratuit, sans pub, s√©curis√©.">

    <meta property="og:title" content="Devenez ma√Ætre de vos finances üöÄ">
    <meta property="og:description" content="Simulateurs Gratuits : Cr√©dit Immo, Rentabilit√© Locative, √âpargne & Ind√©pendance Financi√®re.">
    <meta property="og:image" content="https://img.icons8.com/fluency/500/bullish.png">
    <meta property="og:type" content="website">

    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/bullish.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/32/bullish.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* ==========================================
           4. DESIGN SYSTEM (CSS)
        ========================================== */

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #050505;
            color: white;
            -webkit-tap-highlight-color: transparent;
        }

        /* Fond d√©grad√© anim√© subtil */
        .bg-gradient-custom {
            background: radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.08) 0%, transparent 50%);
        }

        /* Effet de verre (Panneaux principaux) */
        .glass-panel {
            background: rgba(22, 22, 26, 0.75);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            border-radius: 32px;
            overflow: hidden;
        }

        /* Effet de verre (Bandeau Cookies) */
        .cookie-glass {
            background: rgba(20, 20, 25, 0.95);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }

        /* Champs de saisie */
        .input-field {
            background: #0f0f11;
            border: 1px solid #2c2c30;
            color: white;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #6366f1;
            background: #16161a;
            outline: none;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
        }
        ::placeholder { color: #4b5563; opacity: 1; }

        /* Barre lat√©rale */
        .nav-sidebar {
            background: rgba(0,0,0,0.2);
            border-right: 1px solid rgba(255,255,255,0.05);
        }

        /* Boutons Onglets */
        .tab-btn {
            text-align: left;
            padding: 12px 16px;
            border-radius: 12px;
            transition: all 0.3s ease;
            opacity: 0.6;
            font-weight: 600;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .tab-btn:hover { opacity: 1; background: rgba(255,255,255,0.03); }
        .tab-btn.active { opacity: 1; background: rgba(255,255,255,0.08); }

        /* Utilitaires */
        .hidden-section { display: none; }
        .hidden-banner { display: none !important; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }

        /* Switch Inflation */
        .toggle-checkbox:checked { right: 0; border-color: #6366f1; }
        .toggle-checkbox:checked + .toggle-label { background-color: #6366f1; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-black bg-gradient-custom">

    <div id="app-container" class="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-12 gap-6 pb-20">

        <div class="lg:col-span-12 flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 relative flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg shadow-indigo-500/20">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-wide">MY FINANCE</h1>
                    <p class="text-[10px] text-gray-500 uppercase tracking-[0.2em]">Assistant Personnel</p>
                </div>
            </div>

            <button onclick="downloadPDF()" class="flex items-center gap-2 bg-[#1c1c21] hover:bg-[#25252b] border border-white/10 text-xs font-bold px-4 py-2 rounded-lg transition group">
                <svg class="w-4 h-4 text-gray-400 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                <span class="hidden sm:inline text-gray-400 group-hover:text-white">PDF</span>
            </button>
        </div>

        <div class="lg:col-span-5 glass-panel flex flex-col lg:flex-row h-fit">

            <div class="lg:w-1/3 nav-sidebar p-3 flex flex-row lg:flex-col gap-1 overflow-x-auto scrollbar-hide">
                <button onclick="switchTab('epargne')" id="tab-epargne" class="tab-btn active text-indigo-400"><span>üíé</span> √âpargne</button>
                <button onclick="switchTab('objectif')" id="tab-objectif" class="tab-btn text-amber-500"><span>üéØ</span> Objectif</button>
                <button onclick="switchTab('immo')" id="tab-immo" class="tab-btn text-pink-500"><span>üè†</span> Cr√©dit</button>
                <button onclick="switchTab('rentbuy')" id="tab-rentbuy" class="tab-btn text-cyan-400"><span>‚öñÔ∏è</span> Louer/Acheter</button>
                <button onclick="switchTab('capacite')" id="tab-capacite" class="tab-btn text-emerald-400"><span>üöÄ</span> Capacit√©</button>
            </div>

            <div class="lg:w-2/3 p-6 lg:p-8 bg-black/20">

                <div id="form-epargne" class="space-y-5">
                    <h2 class="text-xl font-bold text-indigo-400 mb-4">Simulation √âpargne</h2>
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Capital de d√©part</label>
                        <input type="number" inputmode="decimal" id="capital" placeholder="Ex: 1000" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Ajout mensuel</label>
                        <input type="number" inputmode="decimal" id="mensuel" placeholder="Ex: 200" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Taux (%)</label>
                            <input type="number" inputmode="decimal" id="taux" placeholder="5" step="0.1" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1 text-center">
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Ann√©es</label>
                            <input type="number" inputmode="decimal" id="duree" placeholder="15" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1 text-center">
                        </div>
                    </div>
                    <div class="flex items-center justify-between bg-[#16161a] p-3 rounded-xl border border-white/5">
                        <span class="text-xs font-medium text-gray-400">Ajuster √† l'inflation (-2%)</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="inflation-check" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 ease-in-out" style="top: 2px; left: 2px;"/>
                            <label for="inflation-check" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
                        </div>
                    </div>
                    <button onclick="calculerEpargne()" class="w-full py-3 rounded-xl font-bold text-white mt-2 bg-indigo-600 hover:bg-indigo-500 transition shadow-lg shadow-indigo-500/20">Calculer</button>
                </div>

                <div id="form-objectif" class="space-y-5 hidden-section">
                    <h2 class="text-xl font-bold text-amber-500 mb-4">Objectif Millionnaire</h2>
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Somme Cibl√©e</label>
                        <input type="number" inputmode="decimal" id="obj-montant" placeholder="Ex: 50000" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1 border-amber-500/30 focus:border-amber-500">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Dans (Ans)</label>
                            <input type="number" inputmode="decimal" id="obj-duree" placeholder="10" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1 text-center">
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Mise/Mois</label>
                            <input type="number" inputmode="decimal" id="obj-mensuel" placeholder="Ex: 200" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1 text-center">
                        </div>
                    </div>
                    <div class="bg-[#16161a] p-3 rounded-xl border border-white/5">
                        <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">D√©part (Optionnel)</label>
                        <input type="number" inputmode="decimal" id="obj-depart" placeholder="Ex: 1000" class="input-field w-full rounded-lg px-3 py-2 text-sm mt-1">
                    </div>
                    <button onclick="calculerObjectif()" class="w-full py-3 rounded-xl font-bold text-white mt-2 bg-amber-600 hover:bg-amber-500 transition shadow-lg shadow-amber-500/20">Trouver le Taux</button>
                </div>

                <div id="form-immo" class="space-y-5 hidden-section">
                    <h2 class="text-xl font-bold text-pink-500 mb-4">Cr√©dit Immobilier</h2>
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Prix du bien</label>
                        <input type="number" inputmode="decimal" id="immo-montant" placeholder="Ex: 250000" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1">
                    </div>
                    <div class="flex items-center justify-between px-1">
                        <label class="text-[11px] font-bold text-gray-500 uppercase tracking-wider">Inclure Notaire (~7.5%)</label>
                        <input type="checkbox" id="notaire-check" class="w-5 h-5 accent-pink-500 rounded cursor-pointer">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Taux (%)</label>
                            <input type="number" inputmode="decimal" id="immo-taux" placeholder="3.8" step="0.1" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1 text-center">
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Ann√©es</label>
                            <input type="number" inputmode="decimal" id="immo-duree" placeholder="25" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1 text-center">
                        </div>
                    </div>
                    <button onclick="calculerImmo()" class="w-full py-3 rounded-xl font-bold text-white mt-2 bg-pink-600 hover:bg-pink-500 transition shadow-lg shadow-pink-500/20">Simuler</button>
                </div>

                <div id="form-rentbuy" class="space-y-5 hidden-section">
                    <h2 class="text-xl font-bold text-cyan-400 mb-4">Louer ou Acheter ?</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[11px] font-bold text-cyan-500 uppercase ml-1">Loyer Actuel</label>
                            <input type="number" inputmode="decimal" id="rb-loyer" placeholder="800" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1">
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-pink-500 uppercase ml-1">Prix Achat</label>
                            <input type="number" inputmode="decimal" id="rb-prix" placeholder="200000" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1">
                        </div>
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Apport Personnel</label>
                        <input type="number" inputmode="decimal" id="rb-apport" placeholder="20000" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1">
                    </div>
                    <button onclick="calculerRentBuy()" class="w-full py-3 rounded-xl font-bold text-white mt-2 bg-gradient-to-r from-cyan-600 to-pink-600 hover:opacity-90 transition shadow-lg shadow-cyan-500/20">Comparer</button>
                </div>

                <div id="form-capacite" class="space-y-5 hidden-section">
                    <h2 class="text-xl font-bold text-emerald-400 mb-4">Ma Capacit√© d'Emprunt</h2>
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Revenus Net</label>
                        <input type="number" inputmode="decimal" id="revenus" placeholder="Ex: 3000" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Charges / Cr√©dits</label>
                        <input type="number" inputmode="decimal" id="charges" placeholder="Ex: 0" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Taux (%)</label>
                            <input type="number" inputmode="decimal" id="cap-taux" placeholder="3.8" step="0.1" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1 text-center">
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-gray-500 uppercase ml-1">Ann√©es</label>
                            <input type="number" inputmode="decimal" id="cap-duree" placeholder="25" class="input-field w-full rounded-xl px-4 py-3 text-lg font-medium mt-1 text-center">
                        </div>
                    </div>
                    <button onclick="calculerCapacite()" class="w-full py-3 rounded-xl font-bold text-white mt-2 bg-emerald-600 hover:bg-emerald-500 transition shadow-lg shadow-emerald-500/20">Calculer Enveloppe</button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-7 flex flex-col gap-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="glass-panel p-6 relative overflow-hidden">
                    <div id="blob-1" class="absolute top-0 right-0 w-32 h-32 bg-indigo-500 rounded-full blur-[60px] opacity-20 -mr-10 -mt-10"></div>
                    <p id="kpi-label-1" class="text-gray-400 text-xs font-bold tracking-widest uppercase">TOTAL</p>
                    <h2 id="kpi-val-1" class="text-4xl font-bold mt-2 tracking-tight">-- ‚Ç¨</h2>
                </div>
                <div class="glass-panel p-6 relative overflow-hidden">
                    <div id="blob-2" class="absolute top-0 right-0 w-32 h-32 bg-purple-500 rounded-full blur-[60px] opacity-20 -mr-10 -mt-10"></div>
                    <p id="kpi-label-2" class="text-indigo-400 text-xs font-bold tracking-widest uppercase">D√âTAILS</p>
                    <h2 id="kpi-val-2" class="text-4xl font-bold mt-2 tracking-tight text-indigo-400">-- ‚Ç¨</h2>
                </div>
            </div>
            <div class="glass-panel p-6 flex-1 min-h-[400px] relative">
                <canvas id="financeChart"></canvas>
            </div>
        </div>
    </div>

    <div id="cookie-banner" class="fixed bottom-0 left-0 right-0 p-4 z-50 hidden-banner">
        <div class="max-w-4xl mx-auto cookie-glass rounded-2xl p-6 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-indigo-500/20 rounded-full flex items-center justify-center flex-shrink-0 text-xl">üç™</div>
                <div>
                    <h3 class="font-bold text-white">Confidentialit√©</h3>
                    <p class="text-xs text-gray-400 mt-1">Mesure d'audience anonyme (Google Analytics).</p>
                </div>
            </div>
            <div class="flex gap-3 w-full md:w-auto">
                <button onclick="gererCookies(false)" class="flex-1 md:flex-none px-6 py-2.5 rounded-xl text-sm font-bold text-gray-400 hover:bg-white/5 transition border border-white/5">Refuser</button>
                <button onclick="gererCookies(true)" class="flex-1 md:flex-none px-6 py-2.5 rounded-xl text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-500 transition shadow-lg shadow-indigo-500/20">Accepter</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION GOOGLE ANALYTICS (CONSENT MODE V2) ---
        const GA_ID = 'G-M20W2D39X7';

        // D√©finition initiale de la fonction gtag (avant le chargement)
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}

        // Par d√©faut : On refuse tout (DENIED)
        gtag('consent', 'default', {
            'ad_storage': 'denied',
            'analytics_storage': 'denied',
            'ad_user_data': 'denied',
            'ad_personalization': 'denied'
        });

        // Chargement du script Google
        const script = document.createElement('script');
        script.src = `https://www.googletagmanager.com/gtag/js?id=${GA_ID}`;
        script.async = true;
        document.head.appendChild(script);

        gtag('js', new Date());
        gtag('config', GA_ID);

        // --- 2. GESTION DU BANDEAU COOKIE ---
        const banner = document.getElementById('cookie-banner');
        const consent = localStorage.getItem('cookieConsent');

        function updateConsent(granted) {
            const status = granted ? 'granted' : 'denied';

            // Mise √† jour du consentement pour Google
            gtag('consent', 'update', {
                'ad_storage': status,
                'analytics_storage': status,
                'ad_user_data': status,
                'ad_personalization': status
            });

            // Sauvegarde du choix dans le navigateur
            localStorage.setItem('cookieConsent', granted ? 'accepted' : 'refused');
            banner.classList.add('hidden-banner');
        }

        // Affichage du bandeau si aucun choix n'a √©t√© fait
        if (!consent) {
            setTimeout(() => banner.classList.remove('hidden-banner'), 1000);
        } else if (consent === 'accepted') {
            // Si d√©j√† accept√© avant, on active le consentement tout de suite
            updateConsent(true);
        }

        function gererCookies(accepte) {
            updateConsent(accepte);
        }

        // --- 3. CONFIGURATION G√âN√âRALE DU MOTEUR ---
        let myChart;
        Chart.defaults.color = '#6b7280';
        Chart.defaults.font.family = 'Outfit';

        // --- 4. SAUVEGARDE AUTOMATIQUE DES CHAMPS ---
        function saveInputs() {
            document.querySelectorAll('input').forEach(input => {
                if(input.id) {
                    localStorage.setItem(input.id, input.type === 'checkbox' ? input.checked : input.value);
                }
            });
        }

        function loadInputs() {
            document.querySelectorAll('input').forEach(input => {
                if(input.id) {
                    const val = localStorage.getItem(input.id);
                    if(val !== null) {
                        input.type === 'checkbox' ? input.checked = (val === 'true') : input.value = val;
                    }
                }
            });
        }
        // On √©coute chaque changement pour sauvegarder
        document.addEventListener('input', saveInputs);

        // --- 5. G√âN√âRATION PDF ---
        function downloadPDF() {
            const element = document.getElementById('app-container');
            const opt = {
                margin: [10, 10],
                filename: 'ma-simulation-finance.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, backgroundColor: '#050505' },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            html2pdf().set(opt).from(element).save();
        }

        // --- 6. SYST√àME D'ONGLETS ---
        function switchTab(tab) {
            const tabs = ['epargne', 'immo', 'capacite', 'objectif', 'rentbuy'];

            // On cache tous les onglets
            tabs.forEach(t => {
                document.getElementById('form-' + t).classList.add('hidden-section');
                document.getElementById('tab-' + t).classList.remove('active');
            });

            // On affiche l'onglet demand√©
            document.getElementById('form-' + tab).classList.remove('hidden-section');
            document.getElementById('tab-' + tab).classList.add('active');

            // On lance le calcul associ√©
            if(tab === 'epargne') calculerEpargne();
            if(tab === 'immo') calculerImmo();
            if(tab === 'capacite') calculerCapacite();
            if(tab === 'objectif') calculerObjectif();
            if(tab === 'rentbuy') calculerRentBuy();
        }

        // --- 7. OUTILS DE FORMATAGE ---
        function formatMoney(amount) {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(amount);
        }

        function updateKPI(l1, v1, l2, v2, colorClass, blobColor) {
            document.getElementById('kpi-label-1').innerText = l1;
            document.getElementById('kpi-val-1').innerText = typeof v1 === 'number' ? formatMoney(v1) : v1;

            document.getElementById('kpi-label-2').innerText = l2;
            document.getElementById('kpi-val-2').innerText = typeof v2 === 'number' ? formatMoney(v2) : v2;
            document.getElementById('kpi-val-2').className = "text-4xl font-bold mt-2 tracking-tight " + colorClass;

            // Animation des blobs de couleur en arri√®re-plan
            const blobClass = `absolute top-0 right-0 w-32 h-32 rounded-full blur-[60px] opacity-20 -mr-10 -mt-10 ${blobColor}`;
            document.getElementById('blob-1').className = blobClass;
            document.getElementById('blob-2').className = blobClass;
        }

        // --- 8. MOTEURS DE CALCUL (LOGIQUE M√âTIER) ---

        // A. CALCUL √âPARGNE
        function calculerEpargne() {
            const capital = parseFloat(document.getElementById('capital').value);
            const mensuel = parseFloat(document.getElementById('mensuel').value);
            let taux = parseFloat(document.getElementById('taux').value);
            const duree = parseInt(document.getElementById('duree').value);
            const inflation = document.getElementById('inflation-check').checked;

            if(isNaN(capital) || isNaN(duree)) return;

            if(inflation) taux = taux - 2;

            const labels = [];
            const dataInv = [];
            const dataInt = [];

            for (let i = 0; i <= duree; i++) {
                let mois = i * 12;
                let totalVerse = capital + (mensuel * mois);
                let totalReel;

                if (taux !== 0) {
                    totalReel = (capital * Math.pow(1 + taux/100/12, mois)) + (mensuel * ((Math.pow(1 + taux/100/12, mois) - 1) / (taux/100/12)));
                } else {
                    totalReel = totalVerse;
                }

                labels.push("Ann√©e " + i);
                dataInv.push(totalVerse);
                dataInt.push(totalReel - totalVerse);
            }

            let total = dataInv[duree] + dataInt[duree];
            let labelKPI = inflation ? "TOTAL (Ajust√© Inflation)" : "PATRIMOINE TOTAL";

            updateKPI(labelKPI, total, "GAINS BRUTS", dataInt[duree], "text-indigo-400", "bg-indigo-500");
            drawChart(labels, dataInv, dataInt, "Capital Investi", "Int√©r√™ts", '#6366f1', '#a5b4fc');
        }

        // B. CALCUL OBJECTIF
        function calculerObjectif() {
            const cible = parseFloat(document.getElementById('obj-montant').value);
            const duree = parseFloat(document.getElementById('obj-duree').value);
            const mensuel = parseFloat(document.getElementById('obj-mensuel').value) || 0;
            const depart = parseFloat(document.getElementById('obj-depart').value) || 0;

            if(isNaN(cible) || isNaN(duree)) return;

            // Algorithme dichotomique pour trouver le taux
            let minRate = 0;
            let maxRate = 100;
            let foundRate = 0;

            let totalSansInteret = depart + (mensuel * duree * 12);

            if(totalSansInteret >= cible) {
                foundRate = 0;
            } else {
                for(let k=0; k<100; k++) {
                    let guess = (minRate + maxRate) / 2;
                    let tm = guess / 100 / 12;
                    let nbMois = duree * 12;
                    let fv = (depart * Math.pow(1+tm, nbMois)) + (mensuel * ((Math.pow(1+tm, nbMois)-1)/tm));

                    if(fv < cible) minRate = guess;
                    else maxRate = guess;
                }
                foundRate = maxRate;
            }

            updateKPI("OBJECTIF", cible, "TAUX REQUIS", foundRate.toFixed(2) + " %", "text-amber-500", "bg-amber-500");

            const labels = [];
            const dataCapital = [];
            const dataInterets = [];

            for(let i=0; i<=duree; i++) {
                let tm = foundRate / 100 / 12;
                let mois = i*12;
                let cap = depart + (mensuel * mois);
                let total = foundRate > 0 ? (depart * Math.pow(1+tm, mois)) + (mensuel * ((Math.pow(1+tm, mois)-1)/tm)) : cap;

                labels.push("Ann√©e "+i);
                dataCapital.push(cap);
                dataInterets.push(total - cap);
            }

            drawChart(labels, dataCapital, dataInterets, "Vos Versements", "Int√©r√™ts Requis", '#d97706', '#fcd34d');
        }

        // C. CALCUL CR√âDIT IMMO
        function calculerImmo() {
            let montant = parseFloat(document.getElementById('immo-montant').value);
            const taux = parseFloat(document.getElementById('immo-taux').value) / 100;
            const duree = parseInt(document.getElementById('immo-duree').value);
            const withNotaire = document.getElementById('notaire-check').checked;

            if(isNaN(montant) || isNaN(taux)) return;

            let montantEmprunte = montant;
            let fraisNotaire = 0;
            if (withNotaire) {
                fraisNotaire = montant * 0.075;
                montantEmprunte += fraisNotaire;
            }

            const nbMois = duree * 12;
            const tm = taux / 12;
            let mensualite = taux > 0 ? montantEmprunte * (tm * Math.pow(1 + tm, nbMois)) / (Math.pow(1 + tm, nbMois) - 1) : montantEmprunte / nbMois;

            const labels = [];
            const dataCap = [];
            const dataInt = [];

            let solde = montantEmprunte;
            let cumulInt = 0;
            let cumulCap = 0;

            for (let m = 0; m <= nbMois; m++) {
                if (m % 12 === 0) {
                    labels.push(m/12 + " ans");
                    dataCap.push(cumulCap);
                    dataInt.push(cumulInt);
                }
                if (m < nbMois) {
                    let intM = solde * tm;
                    let capM = mensualite - intM;
                    solde -= capM;
                    cumulInt += intM;
                    cumulCap += capM;
                }
            }

            let detailVal = withNotaire ? cumulInt + fraisNotaire : cumulInt;
            updateKPI("MENSUALIT√â", mensualite, "CO√õT TOTAL", detailVal, "text-pink-500", "bg-pink-500");
            drawChart(labels, dataCap, dataInt, "Rembours√©", "Co√ªt", '#db2777', '#f472b6');
        }

        // D. CALCUL LOUER VS ACHETER
        function calculerRentBuy() {
            const loyer = parseFloat(document.getElementById('rb-loyer').value);
            const prix = parseFloat(document.getElementById('rb-prix').value);
            const apport = parseFloat(document.getElementById('rb-apport').value) || 0;

            if(isNaN(loyer) || isNaN(prix)) return;

            // Hypoth√®ses
            const duree = 25;
            const tauxImmo = 0.04;
            const tauxEpargne = 0.03;
            const appImmo = 0.01;
            const fraisNotaire = prix * 0.075;
            const chargesProprio = prix * 0.01;

            const emprunt = prix + fraisNotaire - apport;
            const tm = tauxImmo / 12;
            const nbMois = duree * 12;
            const mensualite = emprunt * (tm * Math.pow(1+tm, nbMois)) / (Math.pow(1+tm, nbMois)-1);
            const epargneMensuelleLocataire = (mensualite + chargesProprio/12) - loyer;

            const labels = [];
            const wealthRenter = [];
            const wealthOwner = [];

            let capitalLocataire = apport;
            let valeurMaison = prix;
            let detteRestante = emprunt;

            for(let an=0; an<=duree; an++) {
                labels.push("Ann√©e "+an);

                if(an > 0) {
                    capitalLocataire = (capitalLocataire + (epargneMensuelleLocataire * 12)) * (1 + tauxEpargne);
                    valeurMaison = valeurMaison * (1 + appImmo);
                    let partInt = detteRestante * tauxImmo;
                    let partCap = (mensualite * 12) - partInt;
                    detteRestante -= partCap;
                }

                wealthRenter.push(capitalLocataire);
                wealthOwner.push(valeurMaison - detteRestante);
            }

            let breakEven = "Jamais";
            for(let i=1; i<wealthOwner.length; i++) {
                if(wealthOwner[i] > wealthRenter[i]) {
                    breakEven = i + " ans";
                    break;
                }
            }

            updateKPI("RENTABLE DANS", breakEven, "PATRIMOINE 25 ANS", wealthOwner[25], "text-cyan-400", "bg-cyan-500");

            const ctx = document.getElementById('financeChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Proprio', data: wealthOwner, borderColor: '#ec4899', borderWidth: 3, fill:false },
                        { label: 'Locataire', data: wealthRenter, borderColor: '#06b6d4', borderWidth: 3, fill:false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: 'white' } }, tooltip: { mode: 'index', intersect: false } },
                    scales: { x: { grid: { display: false }, ticks: { color: '#52525b' } }, y: { grid: { color: '#27272a' }, ticks: { color: '#52525b' } } }
                }
            });
        }

        // E. CALCUL CAPACIT√â D'EMPRUNT
        function calculerCapacite() {
            const revenus = parseFloat(document.getElementById('revenus').value);
            const charges = parseFloat(document.getElementById('charges').value) || 0;
            const taux = parseFloat(document.getElementById('cap-taux').value) / 100;
            const duree = parseInt(document.getElementById('cap-duree').value);

            if(isNaN(revenus) || isNaN(taux)) return;

            const resteAVivre = revenus - charges;
            const mensualiteMax = resteAVivre * 0.35;

            const nbMois = duree * 12;
            const tm = taux / 12;

            let capitalMax = 0;
            if (taux > 0) {
                capitalMax = mensualiteMax * (1 - Math.pow(1 + tm, -nbMois)) / tm;
            } else {
                capitalMax = mensualiteMax * nbMois;
            }

            const coutTotal = (mensualiteMax * nbMois) - capitalMax;

            updateKPI("ENVELOPPE MAX", capitalMax, "MENSUALIT√â MAX (35%)", mensualiteMax, "text-emerald-400", "bg-emerald-500");

            const ctx = document.getElementById('financeChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Capital', 'Co√ªt'],
                    datasets: [{
                        data: [capitalMax, coutTotal],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: 'white', padding: 20 } } },
                    cutout: '70%'
                }
            });
        }

        // --- 9. DESSIN GRAPHIQUE UNIFI√â (Ligne) ---
        function drawChart(labels, d1, d2, l1, l2, c1, c2) {
            const ctx = document.getElementById('financeChart').getContext('2d');
            if (myChart) myChart.destroy();

            let grad1 = ctx.createLinearGradient(0, 0, 0, 400);
            grad1.addColorStop(0, c1 + '80');
            grad1.addColorStop(1, c1 + '00');

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: l2,
                            data: d2,
                            borderColor: c2,
                            backgroundColor: c2 + '40',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: l1,
                            data: d1,
                            borderColor: c1,
                            backgroundColor: grad1,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: 'white', font: { family: 'Outfit' } } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#52525b' } },
                        y: { grid: { color: '#27272a' }, ticks: { color: '#52525b' }, stacked: true }
                    }
                }
            });
        }

        // --- 10. LANCEMENT INITIAL ---
        // On charge les donn√©es sauvegard√©es et on lance l'onglet par d√©faut
        loadInputs();
        if(document.getElementById('capital').value) calculerEpargne();

    </script>
</body>
</html>